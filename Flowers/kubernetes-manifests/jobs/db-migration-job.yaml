apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration
spec:
  template:
    spec:
      containers:
      - name: migrator
        image: bitnami/postgresql:latest
        env:
        - name: PGUSER
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: POSTGRES_USER
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: POSTGRES_PASSWORD
        - name: PGDATABASE
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: POSTGRES_DB
        command: ["/bin/sh", "-c"]
        args:
          - |
            until pg_isready -h postgresql -U $PGUSER -d $PGDATABASE; do
              sleep 2
              echo "Waiting for PostgreSQL..."
            done
            
            psql -h postgresql -U $PGUSER -d $PGDATABASE -c "
              CREATE TABLE IF NOT EXISTS users (
                id BIGSERIAL PRIMARY KEY,
                username VARCHAR(255) NOT NULL UNIQUE,
                firstname VARCHAR(255) NOT NULL,
                lastname VARCHAR(255) NOT NULL,
                email VARCHAR(255) NOT NULL UNIQUE,
                phone VARCHAR(50) NOT NULL
              );"
            
            psql -h postgresql -U $PGUSER -d $PGDATABASE -c "
              CREATE TABLE IF NOT EXISTS auth_users (
                  id BIGSERIAL PRIMARY KEY,
                  user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                  username VARCHAR(255) UNIQUE NOT NULL,
                  password_hash VARCHAR(255) NOT NULL
              );"
              
            psql -h postgresql -U $PGUSER -d $PGDATABASE -c "
              CREATE TABLE IF NOT EXISTS accounts (
                id BIGSERIAL PRIMARY KEY,
                user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                balance DECIMAL(18,2) NOT NULL DEFAULT 0,
                UNIQUE(user_id)
              );"
            
            psql -h postgresql -U $PGUSER -d $PGDATABASE -c "
              CREATE TABLE IF NOT EXISTS orders (
                id BIGSERIAL PRIMARY KEY,
                user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                amount DECIMAL(18,2) NOT NULL,
                status VARCHAR(50) NOT NULL DEFAULT 'Pending',
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                product_id VARCHAR(255),
                quantity INTEGER DEFAULT 0,
                delivery_slot TIMESTAMP
              );"
            
            psql -h postgresql -U $PGUSER -d $PGDATABASE -c "
              CREATE TABLE IF NOT EXISTS notifications (
                id BIGSERIAL PRIMARY KEY,
                user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                email VARCHAR(255) NOT NULL,
                message TEXT NOT NULL,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                status VARCHAR(50) NOT NULL DEFAULT 'Sent'
              );"
            
            echo "Database structure:"
            psql -h postgresql -U $PGUSER -d $PGDATABASE -c "\dt"
            
            echo "Table details:"
            psql -h postgresql -U $PGUSER -d $PGDATABASE -c "\d+ users"
            psql -h postgresql -U $PGUSER -d $PGDATABASE -c "\d+ auth_users"
            psql -h postgresql -U $PGUSER -d $PGDATABASE -c "\d+ accounts"
            psql -h postgresql -U $PGUSER -d $PGDATABASE -c "\d+ orders"
            psql -h postgresql -U $PGUSER -d $PGDATABASE -c "\d+ notifications"
            
            echo "Migration completed successfully!"
      restartPolicy: Never
  backoffLimit: 2